<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Inspe√ß√µes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- √çcones -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --primary: #0097CE;
      --primary-dark: #007fb0;
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #333;
      --border: #e0e0e0;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
    }

    header {
      background: var(--card);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h2 {
      margin: 0;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    input[type="file"] {
      padding: 6px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: #fff;
    }

    button {
      padding: 8px 14px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    button:hover {
      background: var(--primary-dark);
    }

    main {
      padding: 24px;
    }

    .card {
      background: var(--card);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--primary);
      color: #fff;
    }

    th, td {
      padding: 12px 10px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      white-space: nowrap;
    }

    tbody tr:hover {
      background: #f9fbfc;
    }

    input[type="date"] {
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid var(--border);
      font-size: 13px;
    }

    .status {
      margin-bottom: 12px;
      font-size: 14px;
      color: #555;
    }

    .status.success {
      color: green;
    }

    .status.error {
      color: red;
    }

    @media (max-width: 768px) {
      th, td {
        font-size: 13px;
      }
    }
    .card {
  overflow-x: auto;
}
    headers: {
  "Content-Type": "application/json",
  "x-perfil": "admin"
}
  </style>
</head>

<body>

<header>
  <h2><i class="bi bi-clipboard-check"></i> Controle de Inspe√ß√µes</h2>

  <div class="top-actions">
  <div class="top-actions" id="areaAdmin">
  <input type="file" id="excel" accept=".xlsx" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <button onclick="logout()">
    <i class="bi bi-box-arrow-right"></i> Sair
  </button>
</div>
    
</header>

<main>
  <div style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
  <input type="text" id="filtroLider" placeholder="Filtrar por L√≠der">

  <input type="text" id="filtroLocalidade" placeholder="Filtrar por Localidade">

  <input type="date" id="filtroData">
  
  <button onclick="aplicarFiltros()">
    <i class="bi bi-funnel"></i> Filtrar
  </button>

  <button onclick="limparFiltros()">
    <i class="bi bi-x-circle"></i> Limpar
  </button>
  <div class="status" id="status"></div>

  <div class="card" style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
    <th>N√∫mero</th>
    <th>N¬∫ do Plano</th>
    <th>Localidade</th>
    <th>√Årea</th>
    <th>Equipe Avaliada</th>
    <th>Contratada</th>
    <th>L√≠der</th>
    <th>Data da Inspe√ß√£o</th>
    <th>Descri√ß√£o</th>
    <th>Observa√ß√£o</th>
    <th>Fator Gerador</th>
    <th>Status</th>
    <th>Auditorias</th>
    <th>Auditores</th>
    <th>Auditados</th>
    <th>Cadastrante</th>
    <th>Conformidades</th>
    <th>N√£o Conforme</th>
    <th>N√£o Aplic√°vel</th>
    <th>A√ß√µes</th>
    <th>√öltima A√ß√£o Prevista</th>
    <th>Tipo de √Årea</th>
    <th>Respons√°vel pela √Årea</th>
    <th>Colaborador 1</th>
    <th>Colaborador 2</th>
    <th>Auditor 1</th>
    <th>Auditor 2</th>
    <th>Auditor 3</th>
  </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<script>
/* ===============================
   VARI√ÅVEIS GLOBAIS
================================ */
let dadosGlobais = [];

const API = "https://inspecoes.pedro-fillype.workers.dev";
const statusEl = document.getElementById("status");

/* ===============================
   üîê PROTE√á√ÉO LOGIN
================================ */
if (localStorage.getItem("logado") !== "true") {
  window.location.href = "https://coec-epb.github.io/login_inspecoes/";
}
  /* ===============================
   üîë CONTROLE DE PERFIL
================================ */
const perfil = localStorage.getItem("perfil");
const areaAdmin = document.getElementById("areaAdmin");

if (perfil !== "admin") {
  // Esconde importa√ß√£o de Excel
  areaAdmin.querySelector("#excel")?.remove();
}

/* ===============================
   UTILIT√ÅRIOS
================================ */
function setStatus(msg, type = "") {
  statusEl.textContent = msg;
  statusEl.className = `status ${type}`;
}

function logout() {
  localStorage.removeItem("logado");
  window.location.href = "https://coec-epb.github.io/login_inspecoes/";
}

function excelDateToISO(value) {
  if (typeof value === "number") {
    const d = new Date((value - 25569) * 86400 * 1000);
    return d.toISOString().split("T")[0];
  }
  return value || null;
}

/* ===============================
   üìã CARREGAR INSPE√á√ïES
================================ */
async function carregarInspecoes() {
  setStatus("Carregando inspe√ß√µes...");
  try {
    const res = await fetch(`${API}/inspecoes`);
    if (!res.ok) throw new Error();

    dadosGlobais = await res.json();
    renderTabela(dadosGlobais);

  } catch (e) {
    setStatus("Erro ao carregar dados.", "error");
  }
}

/* ===============================
   üßæ RENDER TABELA
================================ */
function renderTabela(dados) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  dados.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.numero ?? ""}</td>
      <td>${item.numero_plano ?? ""}</td>
      <td>${item.localidade ?? ""}</td>
      <td>${item.area ?? ""}</td>
      <td>${item.equipe_avaliada ?? ""}</td>
      <td>${item.contratada ?? ""}</td>
      <td>${item.lider ?? ""}</td>
      <td>${item.data_inspecao ?? ""}</td>
      <td>${item.descricao ?? ""}</td>
      <td>${item.observacao ?? ""}</td>
      <td>${item.fator_gerador ?? ""}</td>
      <td>${item.status ?? ""}</td>
      <td>${item.auditorias ?? ""}</td>
      <td>${item.auditores ?? ""}</td>
      <td>${item.auditados ?? ""}</td>
      <td>${item.cadastrante ?? ""}</td>
      <td>${item.conformidades ?? 0}</td>
      <td>${item.nao_conforme ?? 0}</td>
      <td>${item.nao_aplicavel ?? 0}</td>
      <td>${item.acoes ?? ""}</td>
      <td>${item.ultima_acao_prevista ?? ""}</td>
      <td>${item.tipo_area ?? ""}</td>
      <td>${item.responsavel_area ?? ""}</td>
      <td>${item.colaborador_1 ?? ""}</td>
      <td>${item.colaborador_2 ?? ""}</td>
      <td>${item.auditor_1 ?? ""}</td>
      <td>${item.auditor_2 ?? ""}</td>
      <td>${item.auditor_3 ?? ""}</td>
    `;
    tbody.appendChild(tr);
  });

  setStatus(`Registros exibidos: ${dados.length}`, "success");
}

/* ===============================
   üîç FILTROS
================================ */
function aplicarFiltros() {
  const lider = document.getElementById("filtroLider").value.toLowerCase();
  const localidade = document.getElementById("filtroLocalidade").value.toLowerCase();
  const data = document.getElementById("filtroData").value;

  const filtrado = dadosGlobais.filter(item => {
    const okLider =
      !lider || (item.lider && item.lider.toLowerCase().includes(lider));

    const okLocalidade =
      !localidade || (item.localidade && item.localidade.toLowerCase().includes(localidade));

    const okData =
      !data || (item.data_inspecao && item.data_inspecao.startsWith(data));

    return okLider && okLocalidade && okData;
  });

  renderTabela(filtrado);
}

function limparFiltros() {
  document.getElementById("filtroLider").value = "";
  document.getElementById("filtroLocalidade").value = "";
  document.getElementById("filtroData").value = "";
  renderTabela(dadosGlobais);
}

/* ===============================
   üì• IMPORTAR EXCEL
================================ */
function normalizarLinha(l) {
  return {
    numero: l["N√∫mero"]?.toString().trim() || null,
    numero_plano: l["N√∫mero do plano"] || null,
    localidade: l["Localidade"] || null,
    area: l["√Årea"] || null,
    equipe_avaliada: l["Equipe Avaliada"] || null,
    contratada: l["Contratada"] || null,
    lider: l["L√≠der"] || null,
    data_inspecao: excelDateToISO(l["Data da inspe√ß√£o"]),
    descricao: l["Descri√ß√£o"] || null,
    observacao: l["Observa√ß√£o"] || null,
    fator_gerador: l["Fator Gerador"] || null,
    status: l["Status"] || null,
    auditorias: l["Auditorias"] || null,
    auditores: l["Auditores"] || null,
    auditados: l["Auditados"] || null,
    cadastrante: l["Cadastrante"] || null,
    conformidades: Number(l["Conformidades"] || 0),
    nao_conforme: Number(l["N√£o conforme"] || 0),
    nao_aplicavel: Number(l["N√£o aplic√°vel"] || 0),
    acoes: l["A√ß√µes"] || null,
    ultima_acao_prevista: excelDateToISO(l["√öltima a√ß√£o prevista"]),
    tipo_area: l["Tipo de √Årea"] || null,
    responsavel_area: l["Respons√°vel pela √°rea"] || null,
    colaborador_1: l["COLABORADOR 1"] || null,
    colaborador_2: l["COLABORADOR 2"] || null,
    auditor_1: l["AUDITOR 1"] || null,
    auditor_2: l["AUDITOR 2"] || null,
    auditor_3: l["AUDITOR 3"] || null
  };
}

function chunkArray(arr, size) {
  const chunks = [];
  for (let i = 0; i < arr.length; i += size) {
    chunks.push(arr.slice(i, i + size));
  }
  return chunks;
}

document.getElementById("excel").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  setStatus("Lendo Excel...");

  const data = await file.arrayBuffer();
  const wb = XLSX.read(data);
  const ws = wb.Sheets[wb.SheetNames[0]];
  const raw = XLSX.utils.sheet_to_json(ws, { defval: null });

  const normalizado = raw
    .map(normalizarLinha)
    .filter(l => l.numero);

  const chunks = chunkArray(normalizado, 50);

  for (let i = 0; i < chunks.length; i++) {
    const resp = await fetch(`${API}/importar-excel`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(chunks[i])
    });

    if (!resp.ok) {
      const err = await resp.text();
      setStatus(`Erro no lote ${i + 1}: ${err}`, "error");
      return;
    }

    setStatus(
      `Importando ${Math.min((i + 1) * 50, normalizado.length)} / ${normalizado.length}`,
      "success"
    );
  }

  setStatus("Importa√ß√£o conclu√≠da ‚úî", "success");
  carregarInspecoes();
});

/* ===============================
   üöÄ INICIAR
================================ */
carregarInspecoes();
</script>

</body>
</html>
