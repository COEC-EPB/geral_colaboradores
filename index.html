<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Inspe√ß√µes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- √çcones -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --primary: #0097CE;
      --primary-dark: #007fb0;
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #333;
      --border: #e0e0e0;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
    }

    header {
      background: var(--card);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      position: sticky;
      top: 0;
      z-index: 10;
      gap: 12px;
      flex-wrap: wrap;
    }

    header h2 {
      margin: 0;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    input[type="file"], input[type="text"], input[type="date"] {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      outline: none;
    }

    button {
      padding: 9px 14px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    button:hover { background: var(--primary-dark); }

    button.secondary {
      background: #eee;
      color: #333;
    }
    button.secondary:hover { background: #e5e5e5; }

    main { padding: 24px; }

    .row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .status {
      font-size: 14px;
      color: #555;
      margin: 0;
      flex: 1;
      min-width: 240px;
    }
    .status.success { color: #137333; }
    .status.error { color: #b3261e; }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      overflow: hidden;
    }

    .card.pad { padding: 16px; }

    .table-wrap { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--primary);
      color: #fff;
    }

    th, td {
      padding: 12px 10px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      white-space: nowrap;
      vertical-align: top;
    }

    tbody tr:hover { background: #f9fbfc; }

    /* Modal */
    #modalMedida {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }

    .modal-box {
      width: min(520px, 100%);
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,.2);
    }

    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .modal-head h3 {
      margin: 0;
      color: var(--primary);
      font-size: 16px;
    }

    label {
      font-weight: 600;
      font-size: 13px;
      display: block;
      margin-bottom: 6px;
    }

    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      resize: vertical;
      font-family: inherit;
      font-size: 14px;
      outline: none;
    }

    .hint {
      font-size: 12px;
      color: #777;
      margin-top: 6px;
    }
  .chart-wrap { margin-top: 14px; overflow-x: auto; }
  .chart {
    display: grid;
    grid-template-columns: 54px repeat(12, 1fr);
    gap: 10px;
    min-width: 680px;
    align-items: end;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: #fff;
  }

  .chart .y-label {
    font-size: 12px;
    color: #666;
    align-self: center;
  }

  .chart-col {
    display: flex;
    flex-direction: column;
    gap: 6px;
    align-items: center;
    justify-content: end;
    padding: 6px 0;
  }

  .bars {
    width: 100%;
    height: 160px;
    display: flex;
    gap: 6px;
    align-items: flex-end;
    justify-content: center;
  }

  .bar {
    width: 18px;
    border-radius: 8px;
    border: 1px solid var(--border);
    position: relative;
    cursor: default;
  }

  .bar.inspecoes { background: rgba(0,151,206,.25); border-color: rgba(0,151,206,.35); }
  .bar.naoConforme { background: rgba(255,99,71,.25); border-color: rgba(255,99,71,.35); }

  .bar:hover::after {
  content: attr(data-tip);
  position: absolute;
  top: calc(100% + 8px);   /* ‚úÖ embaixo */
  left: 50%;
  transform: translateX(-50%);
  background: #111;
  color: #fff;
  font-size: 12px;
  padding: 6px 8px;
  border-radius: 8px;
  white-space: nowrap;
  z-index: 9999;          /* ‚úÖ mais alto */
}

  .month {
    font-size: 12px;
    color: #555;
  }

  .legend {
    display: flex;
    gap: 14px;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 10px;
    font-size: 13px;
    color: #555;
  }

  .dot {
    width: 12px;
    height: 12px;
    border-radius: 4px;
    display: inline-block;
    border: 1px solid var(--border);
    margin-right: 6px;
    vertical-align: middle;
  }
  .dot.inspecoes { background: rgba(0,151,206,.25); border-color: rgba(0,151,206,.35); }
  .dot.naoConforme { background: rgba(255,99,71,.25); border-color: rgba(255,99,71,.35); }
</style>

</head>

<body>

<header>
  <h2><i class="bi bi-clipboard-check"></i> Controle de Inspe√ß√µes</h2>

  <div class="top-actions" id="areaAdmin">
    <input type="file" id="excel" accept=".xlsx" />
    <button onclick="logout()">
      <i class="bi bi-box-arrow-right"></i> Sair
    </button>
  </div>
</header>

<main>

  <div class="row">
    <input type="text" id="filtroLider" placeholder="Filtrar por L√≠der">
    <input type="text" id="filtroLocalidade" placeholder="Filtrar por Localidade">
    <input type="date" id="filtroData">

    <button onclick="aplicarFiltros()"><i class="bi bi-funnel"></i> Filtrar</button>
    <button class="secondary" onclick="limparFiltros()"><i class="bi bi-x-circle"></i> Limpar</button>

    <div class="status" id="status"></div>
  </div>

  <div class="card table-wrap">
    <table>
      <thead>
        <tr>
          <th>N√∫mero</th>
          <th>N¬∫ do Plano</th>
          <th>Localidade</th>
          <th>√Årea</th>
          <th>Equipe Avaliada</th>
          <th>Contratada</th>
          <th>L√≠der</th>
          <th>Data da Inspe√ß√£o</th>
          <th>Descri√ß√£o</th>
          <th>Observa√ß√£o</th>
          <th>Fator Gerador</th>
          <th>Status</th>
          <th>Auditorias</th>
          <th>Auditores</th>
          <th>Auditados</th>
          <th>Cadastrante</th>
          <th>Conformidades</th>
          <th>N√£o Conforme</th>
          <th>N√£o Aplic√°vel</th>
          <th>A√ß√µes</th>
          <th>√öltima A√ß√£o Prevista</th>
          <th>Tipo de √Årea</th>
          <th>Respons√°vel pela √Årea</th>
          <th>Colaborador 1</th>
          <th>Colaborador 2</th>
          <th>Auditor 1</th>
          <th>Auditor 2</th>
          <th>Auditor 3</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- ‚úÖ Card Medida Disciplinar -->
  <div class="card pad" style="margin-top:16px;">
    <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
      <div>
        <h3 style="margin:0; color:var(--primary); font-size:16px;">Medida disciplinar?</h3>
        <div style="font-size:13px; color:#666; margin-top:4px;">
          Registre uma medida vinculada ao <b>N√∫mero</b> da inspe√ß√£o.
        </div>
      </div>

      <button type="button" onclick="abrirModalMedida()">
        <i class="bi bi-exclamation-triangle"></i> Adicionar medida
      </button>
    </div>
  </div>

  <!-- ‚úÖ Modal -->
  <div id="modalMedida">
    <div class="modal-box">
      <div class="modal-head">
        <h3>Registrar medida disciplinar</h3>
        <button type="button" class="secondary" onclick="fecharModalMedida()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div style="display:grid; gap:12px; margin-top:12px;">
        <div>
          <label>N√∫mero da inspe√ß√£o</label>
          <input id="mdNumero" type="text" placeholder="Ex: 12345" style="width:100%;">
          <div class="hint">Dica: use o mesmo valor da coluna <b>N√∫mero</b>.</div>
        </div>

        <div>
          <label>Data</label>
          <input id="mdData" type="date" style="width:100%;">
        </div>

        <div>
          <label>Qual foi a medida?</label>
          <textarea id="mdDescricao" rows="4" placeholder="Descreva a medida..."></textarea>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button type="button" class="secondary" onclick="fecharModalMedida()">Cancelar</button>
          <button type="button" onclick="salvarMedida()"><i class="bi bi-check2-circle"></i> Salvar medida</button>
        </div>
      </div>
    </div>
  </div>

 <!-- üìä Estat√≠sticas -->
<div class="card" style="margin-top:16px; margin-bottom:16px; padding:16px;">
  <!-- Cabe√ßalho -->
  <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-end;">
    <div>
      <h3 style="margin:0; color:var(--primary);">Estat√≠sticas</h3>
      <div style="font-size:13px; color:#666; margin-top:4px;">
        Inspe√ß√µes por m√™s + total do ano e soma de n√£o conformes
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
      <div>
        <div style="font-size:12px; font-weight:600; margin-bottom:4px;">Ano</div>
        <input id="statsAno" type="number"
          style="padding:8px; border:1px solid var(--border); border-radius:8px; width:110px;">
      </div>

      <!-- s√≥ admin v√™ -->
      <div id="boxStatsLider" style="display:none;">
        <div style="font-size:12px; font-weight:600; margin-bottom:4px;">L√≠der</div>
        <input id="statsLider" type="text" placeholder="Digite o l√≠der"
          style="padding:8px; border:1px solid var(--border); border-radius:8px; width:260px;">
      </div>

      <button type="button" onclick="carregarStatsMensal()">
        <i class="bi bi-graph-up"></i> Atualizar
      </button>
    </div>
  </div>

  <!-- Gr√°fico (fora do cabe√ßalho, pra n√£o quebrar o layout) -->
  <div class="chart-wrap">
    <div class="chart" id="statsChart">
      <div class="y-label">M√™s</div>
      <!-- colunas entram via JS -->
    </div>

    <div class="legend">
      <span><span class="dot inspecoes"></span>Inspe√ß√µes</span>
      <span><span class="dot naoConforme"></span>N√£o conformes</span>
    </div>
  </div>

  <!-- KPIs -->
  <div style="display:flex; gap:18px; flex-wrap:wrap; margin-top:14px;">
    <div style="padding:10px 12px; background:#f7fbfd; border:1px solid var(--border); border-radius:10px;">
      <div style="font-size:12px; color:#666;">Total do ano</div>
      <div id="kpiTotalAno" style="font-size:22px; font-weight:700;">0</div>
    </div>

    <div style="padding:10px 12px; background:#f7fbfd; border:1px solid var(--border); border-radius:10px;">
      <div style="font-size:12px; color:#666;">Soma n√£o conformes</div>
      <div id="kpiNaoConformes" style="font-size:22px; font-weight:700;">0</div>
    </div>
  </div>

  <!-- Tabela mensal -->
  <div style="margin-top:14px; overflow:auto;">
    <table style="width:100%; border-collapse:collapse;">
      <thead style="background:#eef7fb; color:#333;">
        <tr>
          <th style="padding:10px; border-bottom:1px solid var(--border); text-align:left;">M√™s</th>
          <th style="padding:10px; border-bottom:1px solid var(--border); text-align:left;">Inspe√ß√µes</th>
          <th style="padding:10px; border-bottom:1px solid var(--border); text-align:left;">N√£o conformes</th>
        </tr>
      </thead>
      <tbody id="statsTbody"></tbody>
    </table>
  </div>
</div>

  <div class="card" style="margin-top:16px; padding:16px;">
  <div style="display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap; align-items:flex-end;">
    <div>
      <h3 style="margin:0; color:var(--primary);">Ranking - Pr√≥ximos a auditar</h3>
      <div style="font-size:13px; color:#666; margin-top:4px;">
        Ordenado do mais tempo sem auditoria (ou nunca auditado) ‚Üí primeiro
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
      <div id="boxRankingLider" style="display:none;">
        <div style="font-size:12px; font-weight:600; margin-bottom:4px;">L√≠der</div>
        <input id="rankingLider" type="text" placeholder="Digite o l√≠der"
          style="padding:8px; border:1px solid var(--border); border-radius:8px; width:260px;">
      </div>

      <button type="button" onclick="carregarRanking()">
        <i class="bi bi-list-ol"></i> Atualizar ranking
      </button>
    </div>
  </div>

  <div style="margin-top:12px; overflow:auto;">
    <table style="width:100%; border-collapse:collapse;">
      <thead style="background:#eef7fb; color:#333;">
        <tr>
          <th style="padding:10px; border-bottom:1px solid var(--border); text-align:left;">Rank</th>
          <th style="padding:10px; border-bottom:1px solid var(--border); text-align:left;">Colaborador</th>
          <th style="padding:10px; border-bottom:1px solid var(--border); text-align:left;">Base</th>
          <th style="padding:10px; border-bottom:1px solid var(--border); text-align:left;">Polo</th>
          <th style="padding:10px; border-bottom:1px solid var(--border); text-align:left;">√öltima auditoria</th>
          <th style="padding:10px; border-bottom:1px solid var(--border); text-align:left;">Dias desde</th>
        </tr>
      </thead>
      <tbody id="rankingTbody"></tbody>
    </table>
  </div>
</div>


</main>

<script>
/* ===============================
   CONFIG / SESS√ÉO
================================ */
const API = "https://inspecoes.pedro-fillype.workers.dev";
const statusEl = document.getElementById("status");
let dadosGlobais = [];

if (localStorage.getItem("logado") !== "true") {
  window.location.href = "https://coec-epb.github.io/login_inspecoes/";
}

const perfil = localStorage.getItem("perfil") || "user";
const token = localStorage.getItem("token") || "";

/* Se n√£o tiver token, desloga */
if (!token) logout();

/* remove excel se n√£o for admin */
if (perfil !== "admin") {
  const el = document.getElementById("excel");
  if (el) el.remove();
}

/* ===============================
   HELPERS
================================ */
function setStatus(msg, type = "") {
  statusEl.textContent = msg;
  statusEl.className = `status ${type}`;
}

function logout() {
  localStorage.removeItem("logado");
  localStorage.removeItem("token");
  localStorage.removeItem("perfil");
  localStorage.removeItem("lider");
  window.location.href = "https://coec-epb.github.io/login_inspecoes/";
}

async function apiFetch(path, options = {}) {
  const res = await fetch(`${API}${path}`, {
    ...options,
    headers: {
      "Authorization": `Bearer ${token}`,
      ...(options.headers || {})
    }
  });
  return res;
}


function excelDateToISO(value) {
  if (typeof value === "number") {
    const d = new Date((value - 25569) * 86400 * 1000);
    return d.toISOString().split("T")[0];
  }
  return value || null;
}

/* ===============================
   TABELA
================================ */
function renderTabela(dados) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  dados.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.numero ?? ""}</td>
      <td>${item.numero_plano ?? ""}</td>
      <td>${item.localidade ?? ""}</td>
      <td>${item.area ?? ""}</td>
      <td>${item.equipe_avaliada ?? ""}</td>
      <td>${item.contratada ?? ""}</td>
      <td>${item.lider ?? ""}</td>
      <td>${item.data_inspecao ?? ""}</td>
      <td>${item.descricao ?? ""}</td>
      <td>${item.observacao ?? ""}</td>
      <td>${item.fator_gerador ?? ""}</td>
      <td>${item.status ?? ""}</td>
      <td>${item.auditorias ?? ""}</td>
      <td>${item.auditores ?? ""}</td>
      <td>${item.auditados ?? ""}</td>
      <td>${item.cadastrante ?? ""}</td>
      <td>${item.conformidades ?? 0}</td>
      <td>${item.nao_conforme ?? 0}</td>
      <td>${item.nao_aplicavel ?? 0}</td>
      <td>${item.acoes ?? ""}</td>
      <td>${item.ultima_acao_prevista ?? ""}</td>
      <td>${item.tipo_area ?? ""}</td>
      <td>${item.responsavel_area ?? ""}</td>
      <td>${item.colaborador_1 ?? ""}</td>
      <td>${item.colaborador_2 ?? ""}</td>
      <td>${item.auditor_1 ?? ""}</td>
      <td>${item.auditor_2 ?? ""}</td>
      <td>${item.auditor_3 ?? ""}</td>
    `;
    tbody.appendChild(tr);
  });

  setStatus(`Registros exibidos: ${dados.length}`, "success");
}

/* ===============================
   CARREGAR INSPE√á√ïES (do Worker)
================================ */
async function carregarInspecoes() {
  setStatus("Carregando inspe√ß√µes...");
  try {
    const res = await apiFetch(`/inspecoes`);

    const text = await res.text(); // <-- pega o corpo
    console.log("STATUS /inspecoes:", res.status);
    console.log("BODY /inspecoes:", text);

    if (res.status === 401) return logout();
    if (!res.ok) throw new Error(text);

    dadosGlobais = JSON.parse(text);
    renderTabela(dadosGlobais);
  } catch (e) {
    setStatus("Erro ao carregar dados.", "error");
    console.error(e);
  }
}


/* ===============================
   FILTROS (client-side)
================================ */
function aplicarFiltros() {
  const lider = document.getElementById("filtroLider").value.toLowerCase().trim();
  const localidade = document.getElementById("filtroLocalidade").value.toLowerCase().trim();
  const data = document.getElementById("filtroData").value;

  const filtrado = dadosGlobais.filter(item => {
    const okLider = !lider || (item.lider && item.lider.toLowerCase().includes(lider));
    const okLocalidade = !localidade || (item.localidade && item.localidade.toLowerCase().includes(localidade));
    const okData = !data || (item.data_inspecao && String(item.data_inspecao).startsWith(data));
    return okLider && okLocalidade && okData;
  });

  renderTabela(filtrado);
}

function limparFiltros() {
  document.getElementById("filtroLider").value = "";
  document.getElementById("filtroLocalidade").value = "";
  document.getElementById("filtroData").value = "";
  renderTabela(dadosGlobais);
}

/* ===============================
   IMPORTAR EXCEL (somente admin)
================================ */
function normalizarLinha(l) {
  return {
    numero: l["N√∫mero"]?.toString().trim() || null,
    numero_plano: l["N√∫mero do plano"] || null,
    localidade: l["Localidade"] || null,
    area: l["√Årea"] || null,
    equipe_avaliada: l["Equipe Avaliada"] || null,
    contratada: l["Contratada"] || null,
    lider: l["L√≠der"] || null,
    data_inspecao: excelDateToISO(l["Data da inspe√ß√£o"]),
    descricao: l["Descri√ß√£o"] || null,
    observacao: l["Observa√ß√£o"] || null,
    fator_gerador: l["Fator Gerador"] || null,
    status: l["Status"] || null,
    auditorias: l["Auditorias"] || null,
    auditores: l["Auditores"] || null,
    auditados: l["Auditados"] || null,
    cadastrante: l["Cadastrante"] || null,
    conformidades: Number(l["Conformidades"] || 0),
    nao_conforme: Number(l["N√£o conforme"] || 0),
    nao_aplicavel: Number(l["N√£o aplic√°vel"] || 0),
    acoes: l["A√ß√µes"] || null,
    ultima_acao_prevista: excelDateToISO(l["√öltima a√ß√£o prevista"]),
    tipo_area: l["Tipo de √Årea"] || null,
    responsavel_area: l["Respons√°vel pela √°rea"] || null,
    colaborador_1: l["COLABORADOR 1"] || null,
    colaborador_2: l["COLABORADOR 2"] || null,
    auditor_1: l["AUDITOR 1"] || null,
    auditor_2: l["AUDITOR 2"] || null,
    auditor_3: l["AUDITOR 3"] || null
  };
}

function chunkArray(arr, size) {
  const chunks = [];
  for (let i = 0; i < arr.length; i += size) chunks.push(arr.slice(i, i + size));
  return chunks;
}

const excelInput = document.getElementById("excel");
if (excelInput && perfil === "admin") {
  excelInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setStatus("Lendo Excel...");

    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const ws = wb.Sheets[wb.SheetNames[0]];
    const raw = XLSX.utils.sheet_to_json(ws, { defval: null });

    const normalizado = raw.map(normalizarLinha).filter(l => l.numero);
    const chunks = chunkArray(normalizado, 50);

    for (let i = 0; i < chunks.length; i++) {
      const resp = await apiFetch(`/importar-excel`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(chunks[i])
      });

      if (resp.status === 401) return logout();

      if (!resp.ok) {
        const err = await resp.text();
        setStatus(`Erro no lote ${i + 1}: ${err}`, "error");
        return;
      }

      setStatus(
        `Importando ${Math.min((i + 1) * 50, normalizado.length)} / ${normalizado.length}`,
        "success"
      );
    }

    setStatus("Importa√ß√£o conclu√≠da ‚úî", "success");
    carregarInspecoes();
  });
}

/* ===============================
   MEDIDAS DISCIPLINARES
================================ */
function abrirModalMedida() {
  document.getElementById("modalMedida").style.display = "flex";
  const hoje = new Date().toISOString().split("T")[0];
  const mdData = document.getElementById("mdData");
  if (!mdData.value) mdData.value = hoje;
}

function fecharModalMedida() {
  document.getElementById("modalMedida").style.display = "none";
}

async function salvarMedida() {
  const numero = document.getElementById("mdNumero").value.trim();
  const data = document.getElementById("mdData").value;
  const descricao = document.getElementById("mdDescricao").value.trim();

  if (!numero) return setStatus("Informe o N√∫mero da inspe√ß√£o.", "error");
  if (!data) return setStatus("Informe a data da medida.", "error");
  if (!descricao) return setStatus("Descreva qual foi a medida.", "error");

  setStatus("Salvando medida disciplinar...", "success");

  const resp = await apiFetch(`/medidas`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ numero, data, descricao })
  });

  if (resp.status === 401) return logout();

  if (!resp.ok) {
    const err = await resp.text();
    setStatus(`Erro ao salvar medida: ${err}`, "error");
    return;
  }

  fecharModalMedida();
  document.getElementById("mdNumero").value = "";
  document.getElementById("mdDescricao").value = "";
  setStatus("Medida registrada com sucesso ‚úî", "success");
}
  function authHeaders() {
  const token = localStorage.getItem("token") || "";
  return {
    "Content-Type": "application/json",
    "Authorization": `Bearer ${token}`
  };
}

function nomeMes(mm) {
  const map = {
    "01":"Jan","02":"Fev","03":"Mar","04":"Abr","05":"Mai","06":"Jun",
    "07":"Jul","08":"Ago","09":"Set","10":"Out","11":"Nov","12":"Dez"
  };
  return map[mm] || mm;
}

async function carregarStatsMensal() {
  try {
    const anoEl = document.getElementById("statsAno");
    const liderEl = document.getElementById("statsLider");

    if (!anoEl.value) anoEl.value = new Date().getFullYear();

    const ano = String(anoEl.value);
    const perfil = localStorage.getItem("perfil") || "user";
    const lider = (perfil === "admin" && liderEl) ? (liderEl.value || "").trim() : "";

    const qs = new URLSearchParams({ ano });
    if (lider) qs.set("lider", lider);

    const res = await fetch(`${API}/stats-mensal?${qs.toString()}`, {
      method: "GET",
      headers: authHeaders()
    });

    const text = await res.text();
    let data = {};
    try { data = JSON.parse(text); } catch {}

    if (!res.ok) {
      setStatus(`Erro ao carregar estat√≠sticas: ${text}`, "error");
      return;
    }

    document.getElementById("kpiTotalAno").textContent = data.total_ano ?? 0;
    document.getElementById("kpiNaoConformes").textContent = data.soma_nao_conforme_ano ?? 0;

    const tbody = document.getElementById("statsTbody");
    tbody.innerHTML = "";

    (data.por_mes || []).forEach(r => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:10px; border-bottom:1px solid var(--border);">${nomeMes(r.mes)}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border);">${r.total}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border);">${r.soma_nao_conforme}</td>
      `;
      tbody.appendChild(tr);
    });

    // ‚úÖ gr√°fico aqui dentro
    renderChart(data.por_mes || []);

    setStatus("Estat√≠sticas atualizadas ‚úî", "success");
  } catch (e) {
    setStatus("Erro ao carregar estat√≠sticas.", "error");
  }
}
  function renderChart(porMes) {
  const chart = document.getElementById("statsChart");
  if (!chart) return;

  // limpa mantendo o label inicial
  chart.innerHTML = `<div class="y-label">M√™s</div>`;

  const maxInspecoes = Math.max(1, ...porMes.map(x => Number(x.total || 0)));
  const maxNC = Math.max(1, ...porMes.map(x => Number(x.soma_nao_conforme || 0)));
  const maxGeral = Math.max(maxInspecoes, maxNC);

  porMes.forEach(r => {
    const total = Number(r.total || 0);
    const nc = Number(r.soma_nao_conforme || 0);

    const hTotal = Math.round((total / maxGeral) * 160);
    const hNc = Math.round((nc / maxGeral) * 160);

    const col = document.createElement("div");
    col.className = "chart-col";

    col.innerHTML = `
      <div class="bars">
        <div class="bar inspecoes" style="height:${hTotal}px" data-tip="Inspe√ß√µes: ${total}"></div>
        <div class="bar naoConforme" style="height:${hNc}px" data-tip="N√£o conformes: ${nc}"></div>
      </div>
      <div class="month">${nomeMes(r.mes)}</div>
    `;

    chart.appendChild(col);
  });
}

// Mostra o campo l√≠der s√≥ para admin
(function initStatsUI(){
  const perfil = localStorage.getItem("perfil") || "user";
  const box = document.getElementById("boxStatsLider");
  if (box && perfil === "admin") box.style.display = "block";

  const anoEl = document.getElementById("statsAno");
  if (anoEl) anoEl.value = new Date().getFullYear();
})();

  function formatarDataBR(iso) {
  if (!iso) return "Nunca";
  // iso: YYYY-MM-DD
  const [y, m, d] = String(iso).split("-");
  if (!y || !m || !d) return iso;
  return `${d}/${m}/${y}`;
}

async function carregarRanking() {
  try {
    const perfil = localStorage.getItem("perfil") || "user";
    const liderEl = document.getElementById("rankingLider");

    const qs = new URLSearchParams();
    if (perfil === "admin" && liderEl && liderEl.value.trim()) {
      qs.set("lider", liderEl.value.trim());
    }

    const res = await fetch(`${API}/ranking-colaboradores?${qs.toString()}`, {
      method: "GET",
      headers: authHeaders()
    });

    const text = await res.text();
    let data = {};
    try { data = JSON.parse(text); } catch {}

    if (!res.ok) {
      setStatus(`Erro ao carregar ranking: ${text}`, "error");
      return;
    }

    const rows = data.results || [];
    const tbody = document.getElementById("rankingTbody");
    tbody.innerHTML = "";

    rows.forEach((r, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:10px; border-bottom:1px solid var(--border);">${idx + 1}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border);">${r.colaborador ?? ""}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border);">${r.base ?? ""}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border);">${r.polo ?? ""}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border);">${formatarDataBR(r.ultima_auditoria)}</td>
        <td style="padding:10px; border-bottom:1px solid var(--border);">${r.dias_desde ?? "-"}</td>
      `;
      tbody.appendChild(tr);
    });

    setStatus(`Ranking carregado: ${rows.length} colaboradores`, "success");
  } catch (e) {
    console.error(e);
    setStatus("Erro ao carregar ranking.", "error");
  }
}

// mostra campo l√≠der no ranking s√≥ para admin
(function initRankingUI(){
  const perfil = localStorage.getItem("perfil") || "user";
  const box = document.getElementById("boxRankingLider");
  if (box && perfil === "admin") box.style.display = "block";
})();

/* ===============================
   INIT
================================ */
carregarStatsMensal();  
carregarInspecoes();
  carregarRanking();

</script>

</body>
</html>
