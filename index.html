<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Inspeções</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px }
table { width:100%; background:#fff; border-collapse:collapse }
th,td { padding:8px; border-bottom:1px solid #ddd }
th { background:#0097CE; color:#fff }
input[type="date"] { width:100% }
.topo { display:flex; justify-content:space-between; margin-bottom:15px }
</style>
</head>

<body>

<div class="topo">
  <input type="file" id="excel">
  <button onclick="logout()">Sair</button>
</div>

<table>
<thead>
<tr>
  <th>Matrícula</th>
  <th>Nome</th>
  <th>Base</th>
  <th>Última Inspeção</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
if (!localStorage.token) location.href = "login.html";

function logout() {
  localStorage.removeItem("token");
  location.href = "login.html";
}

async function carregar() {
  const res = await fetch("/inspecoes", {
    headers: { Authorization: localStorage.token }
  });
  const dados = await res.json();

  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  dados.forEach(d => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.matricula}</td>
      <td>${d.nome}</td>
      <td>${d.base}</td>
      <td>
        <input type="date" value="${d.ultima_inspecao || ""}"
          onchange="salvar('${d.matricula}', this.value)">
      </td>
    `;
    tbody.appendChild(tr);
  });
}

async function salvar(matricula, data) {
  await fetch("/inspecoes", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: localStorage.token
    },
    body: JSON.stringify({ matricula, ultima_inspecao: data })
  });
}

document.getElementById("excel").addEventListener("change", async e => {
  const file = e.target.files[0];
  const data = await file.arrayBuffer();
  const wb = XLSX.read(data);
  const ws = wb.Sheets[wb.SheetNames[0]];
  const json = XLSX.utils.sheet_to_json(ws);

  await fetch("/upload-excel", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: localStorage.token
    },
    body: JSON.stringify(json)
  });

  carregar();
});

carregar();
</script>
</body>
</html>
