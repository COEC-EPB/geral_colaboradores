<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Inspeções</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- XLSX -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Ícones -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">

  <style>
    :root {
      --primary: #0097CE;
      --primary-dark: #007fb0;
      --bg: #f4f6f8;
      --card: #ffffff;
      --text: #333;
      --border: #e0e0e0;
    }

    * { box-sizing: border-box; }

    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      margin: 0;
      padding: 0;
      color: var(--text);
    }

    header {
      background: var(--card);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      position: sticky;
      top: 0;
      z-index: 10;
      gap: 12px;
      flex-wrap: wrap;
    }

    header h2 {
      margin: 0;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    input[type="file"], input[type="text"], input[type="date"] {
      padding: 8px 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      outline: none;
    }

    button {
      padding: 9px 14px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }

    button:hover { background: var(--primary-dark); }

    button.secondary {
      background: #eee;
      color: #333;
    }
    button.secondary:hover { background: #e5e5e5; }

    main { padding: 24px; }

    .row {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .status {
      font-size: 14px;
      color: #555;
      margin: 0;
      flex: 1;
      min-width: 240px;
    }
    .status.success { color: #137333; }
    .status.error { color: #b3261e; }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08);
      overflow: hidden;
    }

    .card.pad { padding: 16px; }

    .table-wrap { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--primary);
      color: #fff;
    }

    th, td {
      padding: 12px 10px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      text-align: left;
      white-space: nowrap;
      vertical-align: top;
    }

    tbody tr:hover { background: #f9fbfc; }

    /* Modal */
    #modalMedida {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
    }

    .modal-box {
      width: min(520px, 100%);
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 12px 40px rgba(0,0,0,.2);
    }

    .modal-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .modal-head h3 {
      margin: 0;
      color: var(--primary);
      font-size: 16px;
    }

    label {
      font-weight: 600;
      font-size: 13px;
      display: block;
      margin-bottom: 6px;
    }

    textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 8px;
      resize: vertical;
      font-family: inherit;
      font-size: 14px;
      outline: none;
    }

    .hint {
      font-size: 12px;
      color: #777;
      margin-top: 6px;
    }
  </style>
</head>

<body>

<header>
  <h2><i class="bi bi-clipboard-check"></i> Controle de Inspeções</h2>

  <div class="top-actions" id="areaAdmin">
    <input type="file" id="excel" accept=".xlsx" />
    <button onclick="logout()">
      <i class="bi bi-box-arrow-right"></i> Sair
    </button>
  </div>
</header>

<main>

  <div class="row">
    <input type="text" id="filtroLider" placeholder="Filtrar por Líder">
    <input type="text" id="filtroLocalidade" placeholder="Filtrar por Localidade">
    <input type="date" id="filtroData">

    <button onclick="aplicarFiltros()"><i class="bi bi-funnel"></i> Filtrar</button>
    <button class="secondary" onclick="limparFiltros()"><i class="bi bi-x-circle"></i> Limpar</button>

    <div class="status" id="status"></div>
  </div>

  <div class="card table-wrap">
    <table>
      <thead>
        <tr>
          <th>Número</th>
          <th>Nº do Plano</th>
          <th>Localidade</th>
          <th>Área</th>
          <th>Equipe Avaliada</th>
          <th>Contratada</th>
          <th>Líder</th>
          <th>Data da Inspeção</th>
          <th>Descrição</th>
          <th>Observação</th>
          <th>Fator Gerador</th>
          <th>Status</th>
          <th>Auditorias</th>
          <th>Auditores</th>
          <th>Auditados</th>
          <th>Cadastrante</th>
          <th>Conformidades</th>
          <th>Não Conforme</th>
          <th>Não Aplicável</th>
          <th>Ações</th>
          <th>Última Ação Prevista</th>
          <th>Tipo de Área</th>
          <th>Responsável pela Área</th>
          <th>Colaborador 1</th>
          <th>Colaborador 2</th>
          <th>Auditor 1</th>
          <th>Auditor 2</th>
          <th>Auditor 3</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <!-- ✅ Card Medida Disciplinar -->
  <div class="card pad" style="margin-top:16px;">
    <div style="display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
      <div>
        <h3 style="margin:0; color:var(--primary); font-size:16px;">Medida disciplinar?</h3>
        <div style="font-size:13px; color:#666; margin-top:4px;">
          Registre uma medida vinculada ao <b>Número</b> da inspeção.
        </div>
      </div>

      <button type="button" onclick="abrirModalMedida()">
        <i class="bi bi-exclamation-triangle"></i> Adicionar medida
      </button>
    </div>
  </div>

  <!-- ✅ Modal -->
  <div id="modalMedida">
    <div class="modal-box">
      <div class="modal-head">
        <h3>Registrar medida disciplinar</h3>
        <button type="button" class="secondary" onclick="fecharModalMedida()">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      <div style="display:grid; gap:12px; margin-top:12px;">
        <div>
          <label>Número da inspeção</label>
          <input id="mdNumero" type="text" placeholder="Ex: 12345" style="width:100%;">
          <div class="hint">Dica: use o mesmo valor da coluna <b>Número</b>.</div>
        </div>

        <div>
          <label>Data</label>
          <input id="mdData" type="date" style="width:100%;">
        </div>

        <div>
          <label>Qual foi a medida?</label>
          <textarea id="mdDescricao" rows="4" placeholder="Descreva a medida..."></textarea>
        </div>

        <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
          <button type="button" class="secondary" onclick="fecharModalMedida()">Cancelar</button>
          <button type="button" onclick="salvarMedida()"><i class="bi bi-check2-circle"></i> Salvar medida</button>
        </div>
      </div>
    </div>
  </div>

</main>

<script>
/* ===============================
   CONFIG / SESSÃO
================================ */
const API = "https://inspecoes.pedro-fillype.workers.dev";
const statusEl = document.getElementById("status");
let dadosGlobais = [];

if (localStorage.getItem("logado") !== "true") {
  window.location.href = "https://coec-epb.github.io/login_inspecoes/";
}

const perfil = localStorage.getItem("perfil") || "user";
const token = localStorage.getItem("token") || "";

/* Se não tiver token, desloga */
if (!token) logout();

/* remove excel se não for admin */
if (perfil !== "admin") {
  const el = document.getElementById("excel");
  if (el) el.remove();
}

/* ===============================
   HELPERS
================================ */
function setStatus(msg, type = "") {
  statusEl.textContent = msg;
  statusEl.className = `status ${type}`;
}

function logout() {
  localStorage.removeItem("logado");
  localStorage.removeItem("token");
  localStorage.removeItem("perfil");
  localStorage.removeItem("lider");
  window.location.href = "https://coec-epb.github.io/login_inspecoes/";
}

async function apiFetch(path, options = {}) {
  const res = await fetch(`${API}${path}`, {
    ...options,
    headers: {
      ...(options.headers || {}),
      "Authorization": `Bearer ${token}`
    }
  });
  return res;
}

function excelDateToISO(value) {
  if (typeof value === "number") {
    const d = new Date((value - 25569) * 86400 * 1000);
    return d.toISOString().split("T")[0];
  }
  return value || null;
}

/* ===============================
   TABELA
================================ */
function renderTabela(dados) {
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  dados.forEach(item => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.numero ?? ""}</td>
      <td>${item.numero_plano ?? ""}</td>
      <td>${item.localidade ?? ""}</td>
      <td>${item.area ?? ""}</td>
      <td>${item.equipe_avaliada ?? ""}</td>
      <td>${item.contratada ?? ""}</td>
      <td>${item.lider ?? ""}</td>
      <td>${item.data_inspecao ?? ""}</td>
      <td>${item.descricao ?? ""}</td>
      <td>${item.observacao ?? ""}</td>
      <td>${item.fator_gerador ?? ""}</td>
      <td>${item.status ?? ""}</td>
      <td>${item.auditorias ?? ""}</td>
      <td>${item.auditores ?? ""}</td>
      <td>${item.auditados ?? ""}</td>
      <td>${item.cadastrante ?? ""}</td>
      <td>${item.conformidades ?? 0}</td>
      <td>${item.nao_conforme ?? 0}</td>
      <td>${item.nao_aplicavel ?? 0}</td>
      <td>${item.acoes ?? ""}</td>
      <td>${item.ultima_acao_prevista ?? ""}</td>
      <td>${item.tipo_area ?? ""}</td>
      <td>${item.responsavel_area ?? ""}</td>
      <td>${item.colaborador_1 ?? ""}</td>
      <td>${item.colaborador_2 ?? ""}</td>
      <td>${item.auditor_1 ?? ""}</td>
      <td>${item.auditor_2 ?? ""}</td>
      <td>${item.auditor_3 ?? ""}</td>
    `;
    tbody.appendChild(tr);
  });

  setStatus(`Registros exibidos: ${dados.length}`, "success");
}

/* ===============================
   CARREGAR INSPEÇÕES (do Worker)
================================ */
async function carregarInspecoes() {
  setStatus("Carregando inspeções...");
  try {
    const res = await apiFetch(`/inspecoes`);
    if (res.status === 401) return logout();
    if (!res.ok) throw new Error(await res.text());

    dadosGlobais = await res.json();
    renderTabela(dadosGlobais);
  } catch (e) {
    setStatus("Erro ao carregar dados.", "error");
  }
}

/* ===============================
   FILTROS (client-side)
================================ */
function aplicarFiltros() {
  const lider = document.getElementById("filtroLider").value.toLowerCase().trim();
  const localidade = document.getElementById("filtroLocalidade").value.toLowerCase().trim();
  const data = document.getElementById("filtroData").value;

  const filtrado = dadosGlobais.filter(item => {
    const okLider = !lider || (item.lider && item.lider.toLowerCase().includes(lider));
    const okLocalidade = !localidade || (item.localidade && item.localidade.toLowerCase().includes(localidade));
    const okData = !data || (item.data_inspecao && String(item.data_inspecao).startsWith(data));
    return okLider && okLocalidade && okData;
  });

  renderTabela(filtrado);
}

function limparFiltros() {
  document.getElementById("filtroLider").value = "";
  document.getElementById("filtroLocalidade").value = "";
  document.getElementById("filtroData").value = "";
  renderTabela(dadosGlobais);
}

/* ===============================
   IMPORTAR EXCEL (somente admin)
================================ */
function normalizarLinha(l) {
  return {
    numero: l["Número"]?.toString().trim() || null,
    numero_plano: l["Número do plano"] || null,
    localidade: l["Localidade"] || null,
    area: l["Área"] || null,
    equipe_avaliada: l["Equipe Avaliada"] || null,
    contratada: l["Contratada"] || null,
    lider: l["Líder"] || null,
    data_inspecao: excelDateToISO(l["Data da inspeção"]),
    descricao: l["Descrição"] || null,
    observacao: l["Observação"] || null,
    fator_gerador: l["Fator Gerador"] || null,
    status: l["Status"] || null,
    auditorias: l["Auditorias"] || null,
    auditores: l["Auditores"] || null,
    auditados: l["Auditados"] || null,
    cadastrante: l["Cadastrante"] || null,
    conformidades: Number(l["Conformidades"] || 0),
    nao_conforme: Number(l["Não conforme"] || 0),
    nao_aplicavel: Number(l["Não aplicável"] || 0),
    acoes: l["Ações"] || null,
    ultima_acao_prevista: excelDateToISO(l["Última ação prevista"]),
    tipo_area: l["Tipo de Área"] || null,
    responsavel_area: l["Responsável pela área"] || null,
    colaborador_1: l["COLABORADOR 1"] || null,
    colaborador_2: l["COLABORADOR 2"] || null,
    auditor_1: l["AUDITOR 1"] || null,
    auditor_2: l["AUDITOR 2"] || null,
    auditor_3: l["AUDITOR 3"] || null
  };
}

function chunkArray(arr, size) {
  const chunks = [];
  for (let i = 0; i < arr.length; i += size) chunks.push(arr.slice(i, i + size));
  return chunks;
}

const excelInput = document.getElementById("excel");
if (excelInput && perfil === "admin") {
  excelInput.addEventListener("change", async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    setStatus("Lendo Excel...");

    const data = await file.arrayBuffer();
    const wb = XLSX.read(data);
    const ws = wb.Sheets[wb.SheetNames[0]];
    const raw = XLSX.utils.sheet_to_json(ws, { defval: null });

    const normalizado = raw.map(normalizarLinha).filter(l => l.numero);
    const chunks = chunkArray(normalizado, 50);

    for (let i = 0; i < chunks.length; i++) {
      const resp = await apiFetch(`/importar-excel`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(chunks[i])
      });

      if (resp.status === 401) return logout();

      if (!resp.ok) {
        const err = await resp.text();
        setStatus(`Erro no lote ${i + 1}: ${err}`, "error");
        return;
      }

      setStatus(
        `Importando ${Math.min((i + 1) * 50, normalizado.length)} / ${normalizado.length}`,
        "success"
      );
    }

    setStatus("Importação concluída ✔", "success");
    carregarInspecoes();
  });
}

/* ===============================
   MEDIDAS DISCIPLINARES
================================ */
function abrirModalMedida() {
  document.getElementById("modalMedida").style.display = "flex";
  const hoje = new Date().toISOString().split("T")[0];
  const mdData = document.getElementById("mdData");
  if (!mdData.value) mdData.value = hoje;
}

function fecharModalMedida() {
  document.getElementById("modalMedida").style.display = "none";
}

async function salvarMedida() {
  const numero = document.getElementById("mdNumero").value.trim();
  const data = document.getElementById("mdData").value;
  const descricao = document.getElementById("mdDescricao").value.trim();

  if (!numero) return setStatus("Informe o Número da inspeção.", "error");
  if (!data) return setStatus("Informe a data da medida.", "error");
  if (!descricao) return setStatus("Descreva qual foi a medida.", "error");

  setStatus("Salvando medida disciplinar...", "success");

  const resp = await apiFetch(`/medidas`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ numero, data, descricao })
  });

  if (resp.status === 401) return logout();

  if (!resp.ok) {
    const err = await resp.text();
    setStatus(`Erro ao salvar medida: ${err}`, "error");
    return;
  }

  fecharModalMedida();
  document.getElementById("mdNumero").value = "";
  document.getElementById("mdDescricao").value = "";
  setStatus("Medida registrada com sucesso ✔", "success");
}

/* ===============================
   INIT
================================ */
carregarInspecoes();
</script>

</body>
</html>
