<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Inspeções</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
table{width:100%;background:#fff;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #ddd}
th{background:#0097CE;color:#fff}
</style>
</head>
<body>

<h2>Inspeções</h2>
<input type="file" id="excel"><br><br>

<table>
<thead>
<tr>
<th>Matrícula</th><th>Nome</th><th>Base</th><th>Última Inspeção</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<script>
if(!localStorage.token) location.href="/";

async function carregar(){
  const r = await fetch("/inspecoes",{ headers:{Authorization:localStorage.token}});
  const dados = await r.json();
  const tbody=document.getElementById("tbody");
  tbody.innerHTML="";
  dados.forEach(d=>{
    tbody.innerHTML+=\`
      <tr>
        <td>\${d.matricula}</td>
        <td>\${d.nome}</td>
        <td>\${d.base}</td>
        <td>
          <input type="date" value="\${d.ultima_inspecao||""}"
            onchange="salvar('\${d.matricula}',this.value)">
        </td>
      </tr>\`;
  });
}

async function salvar(matricula,data){
  await fetch("/inspecoes",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:localStorage.token
    },
    body:JSON.stringify({matricula,ultima_inspecao:data})
  });
}

document.getElementById("excel").addEventListener("change", async e=>{
  const file=e.target.files[0];
  const data=await file.arrayBuffer();
  const wb=XLSX.read(data);
  const ws=wb.Sheets[wb.SheetNames[0]];
  const json=XLSX.utils.sheet_to_json(ws);

  await fetch("/upload-excel",{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      Authorization:localStorage.token
    },
    body:JSON.stringify(json)
  });
  carregar();
});

carregar();
</script>
</body>
</html>
